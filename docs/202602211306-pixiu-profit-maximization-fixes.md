# 貔貅 (Pixiu) — 盈利最大化系统升级与修复方案

## 升级背景与核心目标

当前貔貅（Pixiu）系统已具备完整的数据获取、量化策略、LLM分析和学习闭环等架构，但为了实现**“赚钱赚钱赚钱”**这个核心目标，在细节的资金管理、风控保护以及市场适应度上存在几个致命逻辑漏洞。这些漏洞可能导致回测和AI学习看起来在赚钱，但在实盘中却会不断产生亏损。

本升级方案旨在通过修改相关核心模块，堵住亏损漏洞，并放大盈利潜能，提升整体系统的夏普比率（风险调整后收益）和绝对收益。

## 具体操作内容与逻辑说明

### 1. 市场状态跨资产适配 (Market Regime Cross-Asset Adaptation)
*   **当前问题**: 在 `src/analysis/market_regime.py` 中，仅使用沪深300和北向资金来判断整体市场的状态（牛/熊/震荡）。但是基金池（`config.py`）里包含了美国市场（QDII）和黄金等资产。当A股处于熊市时，系统会错误地压制美股和黄金等资产的仓位和指标，导致错失海外牛市或避险黄金的上涨机会。
*   **升级内容**: 
    1. 修改 `market_regime.py` 使其支持传入指定的参考指数，支持通过资产类别（A股、美股、黄金、债券）分别判定独立的市场状态。
    2. 对于 QDII 使用纳斯达克 100 联接（如广发纳指作为参考标的），对于黄金使用黄金联接作为参考。并在信号合成时使用各自的专属 Regime 进行降权或加权。

### 2. 回测与学习引擎的惩罚性费率修正 (Drawdown & Short-term Fee Penalty)
*   **当前问题**: 公募联接基金对持有不满 7 天有 1.5% 的惩罚性赎回费。当前 `src/strategy/trend_following.py` 的回测及 `src/analysis/learner.py` 里面的 `return_7d > 0` 只看净值变化，忽略了 1.65% (1.5% + 0.15%) 的综合摩擦成本。这会让 AI “学会”频繁做短线，实盘中产生大量手续费磨损。
*   **升级内容**:
    1. 在 `learner.py` 的信号验证里，如果是 7 天的信号验证（`return_7d`），必须先扣除 1.5% 赎回费后再判断预测是“正确”还是“错误”。
    2. 在策略的回测逻辑（`trend_following.py` 等）中，对持有不足 7 天的卖出（哪怕是移动止盈）强制扣除 1.5% 的手续费。

### 3. 动态波动率止损 (Dynamic Volatility Stop-loss)
*   **当前问题**: 全局硬编码了 `single_fund_stop_loss = 0.08` (8%) 的刚性止损。但这对于高波动的纳斯达克或创业板很容易被短期回调扫出局；对于低波动的纯债或超级大盘股又止损过晚。
*   **升级内容**:
    修改策略内部在回测和信号验证时的止损逻辑，通过动态计算目标标的的波动率，分配独立的止损阈值（如针对低波动资产设置严格的严密止损，针对高波动资产设置相对宽容的止损）。

### 4. 激活半凯利公式动态仓位分配 (Activate Kelly Criterion)
*   **当前问题**: `src/risk/position_sizing.py` 中虽然计算了 `calculate_kelly_position` 凯利公式但是未使用。当前所有的加仓都是根据“置信度 * 固定比例”来线性计算的，导致高盈亏比的优秀标的没有拿到足够的筹码。
*   **升级内容**:
    在 `calculate_position_size` 中真正结合策略（或整体系统）的胜率(`win_rate`)、平均盈利和平均亏损，利用凯利公式动态分配资金，让系统将资金重仓于经过历史检验的高确定性、高赔率交易机会上。

## 实施路径

1. 修改 `src/analysis/market_regime.py`。
2. 修改 `src/analysis/learner.py`，更新验证逻辑。
3. 修改 `src/strategy/trend_following.py` 回测逻辑以及交易成本计算。
4. 修改 `src/risk/position_sizing.py` 并对接学习引擎获取真实赔率。
5. （可选）修改 `src/strategy/portfolio.py`，组合合成逻辑更好地适配真实仓位。

这些修改将彻底把系统从一个“纸上谈兵的评分机器”转变成一个“实盘对立的赚钱工具”。
